/**
 * \file FeedbackController.C
 * This file is part of LyX, the document processor.
 * Licence details can be found in the file COPYING.
 *
 * \author Angus Leeming
 *
 * Full author contact details are available in file CREDITS
 */

/* A common interface for posting feedback messages to a message widget in
 * xforms.
 * Derive FormBase and FormBaseDeprecated from it, so daughter classes of
 * either can use the same interface.
 */

#include <config.h>

#ifdef __GNUG__
#pragma implementation
#endif

#include "FeedbackController.h"
#include "gettext.h"        // _()
#include "xforms_helpers.h" // formatted
#include "support/LAssert.h"

#include "BoostFormat.h"

#include FORMS_H_LOCATION

FeedbackController::FeedbackController()
	: warning_posted_(false), message_widget_(0)
{}


FeedbackController::~FeedbackController()
{}


void FeedbackController::setMessageWidget(FL_OBJECT * ob)
{
	lyx::Assert(ob && ob->objclass == FL_TEXT);
	message_widget_ = ob;
	fl_set_object_lsize(message_widget_, FL_NORMAL_SIZE);
}


// preemptive handler for feedback messages
void FeedbackController::MessageCB(FL_OBJECT * ob, int event)
{
	lyx::Assert(ob);

	switch (event) {
	case FL_ENTER:
	{
		string const feedback = getFeedback(ob);
		if (feedback.empty() && warning_posted_)
			break;

		warning_posted_ = false;
		postMessage(getFeedback(ob));
		break;
	}

	case FL_LEAVE:
		if (!warning_posted_)
			clearMessage();
		break;

	default:
		break;
	}
}

#if FL_VERSION > 0 || FL_REVISION >= 89
extern "C" {

void fl_show_tooltip(const char *, int, int);

void fl_hide_tooltip();

}
#endif

void FeedbackController::PrehandlerCB(FL_OBJECT * ob, int event, int key)
{
	lyx::Assert(ob);

	if (ob->objclass == FL_INPUT && event == FL_PUSH && key == 2) {
		// Trigger an input event when pasting in an xforms input object
		// using the middle mouse button.
		InputCB(ob, 0);
		return;
	}


	if (event != FL_ENTER && event != FL_LEAVE)
		return;

	if (ob->objclass == FL_TABFOLDER) {
		// This prehandler is used to work-around an xforms bug and
		// ensures that the form->x, form->y coords of the active
		// tabfolder are up to date.

		// The tabfolder itself can be very narrow, being just
		// the visible border to the tabs.
		// We thus use both FL_ENTER and FL_LEAVE as flags,
		// in case the FL_ENTER event is not caught.

		FL_FORM * const folder = fl_get_active_folder(ob);
		if (folder && folder->window) {
			fl_get_winorigin(folder->window,
					 &(folder->x), &(folder->y));
		}

	}

	if (message_widget_) {
		// Post feedback as the mouse enters the object,
		// remove it as the mouse leaves.
		MessageCB(ob, event);
	}

#if FL_VERSION > 0 || FL_REVISION >= 89
	// Tooltips are not displayed on browser widgets due to an xforms' bug.
	// This is a work-around:
	if (ob->objclass == FL_BROWSER) {
		if (event == FL_ENTER && ob->tooltip && *(ob->tooltip)) {
			fl_show_tooltip(ob->tooltip, ob->form->x + ob->x,
					ob->form->y + ob->y + ob->h + 1);
		} else if (event == FL_LEAVE) {
			fl_hide_tooltip();
		}
	}
#endif
}


void FeedbackController::postWarning(string const & warning)
{
	warning_posted_ = true;
	postMessage(warning);
}


void FeedbackController::clearMessage()
{
	lyx::Assert(message_widget_);

	warning_posted_ = false;

	string const existing = message_widget_->label
		? message_widget_->label : string();
	if (existing.empty())
		return;

	// This trick is needed to get xforms to clear the label...
	fl_set_object_label(message_widget_, "");
	fl_hide_object(message_widget_);
}


void FeedbackController::postMessage(string const & message)
{
	lyx::Assert(message_widget_);

	int const width = message_widget_->w - 10;

#if USE_BOOST_FORMAT
	boost::format fmter = warning_posted_ ?
		boost::format(_("WARNING! %1$s")) :
		boost::format("%1$s");
	fmter % message;

	string const str = formatted(fmter.str(), width, FL_NORMAL_SIZE);
#else
	string const tmp = warning_posted_ ?
		_("WARNING!") + string(" ") + message :
		message;

	string const str = formatted(tmp, width, FL_NORMAL_SIZE);
#endif

	fl_set_object_label(message_widget_, str.c_str());
	FL_COLOR const label_color = warning_posted_ ? FL_RED : FL_LCOL;
	fl_set_object_lcol(message_widget_, label_color);

	if (!message_widget_->visible)
		fl_show_object(message_widget_);
}
